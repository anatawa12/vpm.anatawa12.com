<!doctype html><html lang=en dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Make your components compatible with Avatar Optimizer
  #

This page describes the following two things.

When can components be incompatible with Avatar Optimizer?
How to improve the compatibility?

If you have some question, please feel free to ask on Fediverse (Misskey / Mastodon) or NDMF Discord.

  When can components be incompatible with Avatar Optimizer?
  #

If your components are on the avatar and still exist when Avatar Optimizer processes it,
your components can be incompatible with Avatar Optimizer."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://vpm.anatawa12.com/avatar-optimizer/beta/en/docs/developers/make-your-components-compatible-with-aao/"><meta property="og:site_name" content="Avatar Optimizer (1.8.13)"><meta property="og:title" content="Make your components compatible with Avatar Optimizer"><meta property="og:description" content="Make your components compatible with Avatar Optimizer # This page describes the following two things.
When can components be incompatible with Avatar Optimizer? How to improve the compatibility? If you have some question, please feel free to ask on Fediverse (Misskey / Mastodon) or NDMF Discord.
When can components be incompatible with Avatar Optimizer? # If your components are on the avatar and still exist when Avatar Optimizer processes it, your components can be incompatible with Avatar Optimizer."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><title>Make your components compatible with Avatar Optimizer | Avatar Optimizer (1.8.13)</title><link rel=icon href=/avatar-optimizer/beta/favicon.png><link rel=manifest href=/avatar-optimizer/beta/manifest.json><link rel=canonical href=https://vpm.anatawa12.com/avatar-optimizer/beta/en/docs/developers/make-your-components-compatible-with-aao/><link rel=alternate hreflang=ja href=https://vpm.anatawa12.com/avatar-optimizer/beta/ja/docs/developers/make-your-components-compatible-with-aao/ title="コンポーネントにAvatar Optimizerとの互換性をもたせる"><link rel=stylesheet href=/avatar-optimizer/beta/book.min.60113a8b97a3ffc03c87f522a46a7f47cc2ab4570776eaf10e1f2527b80e37f4.css integrity="sha256-YBE6i5ej/8A8h/UipGp/R8wqtFcHdurxDh8lJ7gON/Q=" crossorigin=anonymous><script defer src=/avatar-optimizer/beta/fuse.min.js></script><script defer src=/avatar-optimizer/beta/en.search.min.cec01a5380e156c1174f7b74f9af4781e117b712195fd0408b0e01978c367a2e.js integrity="sha256-zsAaU4DhVsEXT3t0+a9HgeEXtxIZX9BAiw4Bl4w2ei4=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/avatar-optimizer/beta/en/><span>Avatar Optimizer (1.8.13)</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul class=book-languages><li><input type=checkbox id=languages class=toggle>
<label for=languages class="flex justify-between"><a role=button class="flex align-center"><img src=/avatar-optimizer/beta/svg/translate.svg class=book-icon alt=Languages>
English</a></label><ul><li><a href=/avatar-optimizer/beta/ja/docs/developers/make-your-components-compatible-with-aao/>日本語</a></li></ul></li></ul><ul><li><a class=ao-stable-beta href=https://vpm.anatawa12.com/avatar-optimizer/en/docs/developers/make-your-components-compatible-with-aao/>Goto Stable Docs</a></li><li><a class=ao-stable-beta href=https://vpm.anatawa12.com/avatar-optimizer/beta/en/#installation>How to Install</a></li></ul><ul><li class=book-section-flat><span>Tutorial</span><ul><li><a href=/avatar-optimizer/beta/en/docs/tutorial/basic-usage/>Basic Usage</a></li></ul></li><li><a href=/avatar-optimizer/beta/en/docs/basic-concept/>Basic Concepts</a></li><li><a href=/avatar-optimizer/beta/en/docs/faq/>Frequently Asked Questions</a></li><li><a href=/avatar-optimizer/beta/en/docs/changelog/>Changelog</a></li><li class=book-section-flat><span>Component Kinds</span><ul><li><a href=/avatar-optimizer/beta/en/docs/component-kind/avatar-global-components/>Avatar Global Components</a></li><li><a href=/avatar-optimizer/beta/en/docs/component-kind/edit-skinned-mesh-components/>Edit Skinned Mesh Components</a></li></ul></li><li class=book-section-flat><span>Component Reference</span><ul><li><a href=/avatar-optimizer/beta/en/docs/reference/trace-and-optimize/>Trace And Optimize</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/unused-bones-by-references-tool/>UnusedBonesByReferencesTool</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/merge-skinned-mesh/>Merge Skinned Mesh</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/freeze-blendshape/>Freeze BlendShape</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/merge-toonlit-material/>Merge ToonLit Material</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/remove-mesh-by-blendshape/>Remove Mesh By BlendShape</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/remove-mesh-by-box/>Remove Mesh By Box</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/remove-mesh-by-mask/>Remove Mesh By Mask</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/remove-mesh-by-uv-tile/>Remove Mesh By UV Tile</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/rename-blendshape/>Rename BlendShape</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/clear-endpoint-position/>Clear Endpoint Position</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/merge-bone/>Merge Bone</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/merge-physbone/>Merge PhysBone</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/remove-zero-sized-polygon/>Remove Zero Sized Polygon</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/make-children/>Make Children</a></li></ul></li><li class=book-section-flat><span>For Developers</span><ul><li><a href=/avatar-optimizer/beta/en/docs/developers/asset-description/>Asset Description</a></li><li><a href=/avatar-optimizer/beta/en/docs/developers/component-api/>Component Scripting API</a></li><li><a href=/avatar-optimizer/beta/en/docs/developers/distributing-prefabs/>Distributing Prefabs</a></li><li><a href=/avatar-optimizer/beta/en/docs/developers/make-your-components-compatible-with-aao/ class=active>Make your components compatible with Avatar Optimizer</a></li></ul></li></ul><ul><li class=book-section-flat><span>Blog Posts(日本語)</span><ul><li><a href=/avatar-optimizer/beta/ja/posts/2024-06-27-one-year-since-stable-release/>v1.0.0一周年を記念してちょっと歴史を振り返る</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/avatar-optimizer/beta/svg/menu.svg class=book-icon alt=Menu></label><h3>Make your components compatible with Avatar Optimizer</h3><label for=toc-control><img src=/avatar-optimizer/beta/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#when-incompatible>When can components be incompatible with Avatar Optimizer?</a></li><li><a href=#improve-compatibility>How to improve the compatibility?</a><ul><li><a href=#remove-component>Removing your components</a></li><li><a href=#register-component>Registering your components</a></li><li><a href=#asset-description>Use Asset Description</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=make-your-components-compatible-with-avatar-optimizer>Make your components compatible with Avatar Optimizer
<a class=anchor href=#make-your-components-compatible-with-avatar-optimizer>#</a></h1><p>This page describes the following two things.</p><ul><li>When can components be incompatible with Avatar Optimizer?</li><li>How to improve the compatibility?</li></ul><p>If you have some question, please feel free to ask on <a href=https://misskey.niri.la/@anatawa12>Fediverse (Misskey / Mastodon)</a> or <a href=https://discord.gg/dV4cVpewmM>NDMF Discord</a>.</p><h2 id=when-incompatible>When can components be incompatible with Avatar Optimizer?
<a class=anchor href=#when-incompatible>#</a></h2><p>If your components are on the avatar and still exist when Avatar Optimizer processes it,
your components can be incompatible with Avatar Optimizer.</p><p>Avatar Optimizer is designed to process at the last of the build process,
components unknown to Avatar Optimizer is not supported.</p><p>For example, Avatar Optimizer has Garbage Collection system for Components and others.
To correctly remove unused components, and correctly keep used components,
Avatar Optimizer has to know about all existing components in the Avatar at the optimization.</p><p>To avoid problem with unknown components, Avatar Optimizer currently assumes unknown components</p><ul><li>have to be kept if the component can be enabled and active at runtime.<ul><li>This is because Avatar Optimizer assumes unknown components are runtime components.</li></ul></li><li>will have dependency relationship to all components referenced in the component.</li></ul><p>(Those assumptions above can be changed in the future.)</p><p>However, those assumptions can be incorrect, so Avatar Optimizer will generate a warning like below.</p><p><img src=unknown-component-warning.png alt=unknown-component-warning></p><h2 id=improve-compatibility>How to improve the compatibility?
<a class=anchor href=#improve-compatibility>#</a></h2><p>To improve the compatibility, you may implement one of the following methods.</p><ol><li><p>Remove your components before Avatar Optimizer processes as much as possible.</p><p>If your component is not working at runtime, (in other words, it&rsquo;s a build-time or edit mode only component),
it&rsquo;s mostly better for your tool to process avatar before Avatar Optimizer processes,
and remove your components before Avatar Optimizer processes.</p><p>Please refer <a href=#remove-component>section below</a> for more details.</p><p>Avatar Optimizer internally uses this method for most Avatar Optimizer components,
that will be processed before Trace and Optimize.</p></li><li><p>Register your components to Avatar Optimizer with API</p><p>If your component is working at runtime, or your tool actually wants to keep your components for processing avatar after Avatar Optimizer processes,
you can register your components to Avatar Optimizer to tell about your components.</p><p>Please refer <a href=#register-component>section below</a> for more details.</p><p>Avatar Optimizer internally uses this method to keep some components that are processed after Trace and Optimize,
and components from Unity, VRCSDK, and other avatar platform components.</p></li><li><p>Register your components as no problems to remove with Asset Description.</p><p>Since Avatar Optimizer v1.7.0, you can use <a href=../asset-description>Asset Description</a> to register components only for holding data
for edit-mode tools, that doesn&rsquo;t affects on build or at runtime.
If your tool process nothing at build time or runtime, you can use this to register your components instead of
removing your components before Avatar Optimizer processes.</p><p>Please refer <a href=../asset-description>Asset Description</a> for more details.</p><p>If your tool process something at build time or runtime, registering with Asset Description is not recommended.
If you use Asset Description for components that process something at build time or runtime, it may cause unexpectedly
removing your components and your tool not working properly when the execution order is incorrect or unexpectedly changed.</p><p>Avatar Optimizer internally uses this method to keep compatibility with well-known edit-mode tools.</p></li></ol><h3 id=remove-component>Removing your components
<a class=anchor href=#remove-component>#</a></h3><p>There are several ways to process and remove your components from avatar before Avatar Optimizer processes on build. You can use <a href=https://docs.unity3d.com/2022.3/Documentation/ScriptReference/Object.DestroyImmediate.html><code>DestroyImmediate</code></a> method for removing your components.</p><p>If your tool is a non-destructive tool based on NDMF<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, you can remove your components before the phases
prior to the Optimizing phase of NDMF or before <code>com.anatawa12.avatar-optimizer</code> plugin
(with <a href=https://ndmf.nadena.dev/api/nadena.dev.ndmf.fluent.Sequence.html#nadena_dev_ndmf_fluent_Sequence_BeforePlugin_System_String_System_String_System_Int32_><code>BeforePlugin</code></a>) in the Optimizing phase.
If your tool removes your components in Optimizing phase, it&rsquo;s highly recommended to specify <a href=https://ndmf.nadena.dev/api/nadena.dev.ndmf.fluent.Sequence.html#nadena_dev_ndmf_fluent_Sequence_BeforePlugin_System_String_System_String_System_Int32_><code>BeforePlugin</code></a>
even if your default callback order is before <code>com.anatawa12.avatar-optimizer</code> plugin.</p><p>If your tool is a non-destructive tool not based on NDMF<sup id=fnref1:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, removing your components before
the NDMF&rsquo;s Optimizing phase is recommended.
In this case, current NDMF executes Optimizing phase in order <code>-1025</code>, which is JUST before VRCSDK&rsquo;s <code>RemoveAvatarEditorOnly</code>
callback, so your tool should remove components with <code>IVRCSDKPreprocessAvatarCallback</code> with <code>callbackOrder</code> smaller than <code>-1025</code>.</p><p>If your components is only for holding data for your edit-mode tool and doesn&rsquo;t affects on build or at runtime,
you can remove your components in <code>IVRCSDKPreprocessAvatarCallback</code> as described above, or
you can simply use <a href=../asset-description>Asset Description</a> to register your components as safe-to-remove components.</p><h3 id=register-component>Registering your components
<a class=anchor href=#register-component>#</a></h3><p>If you want to keep your component after Avatar Optimizer processes,
you can register your components to Avatar Optimizer to tell about your components.</p><p>First, to call APIs of Avatar Optimizer, please make an assembly definition file<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> if your tool doesn&rsquo;t have.</p><p>Next, add <code>com.anatawa12.avatar-optimizer.api.editor</code> to assembly references in asmdef file.<br>If your tool doesn&rsquo;t want to depend on Avatar Optimizer, please use <a href=https://docs.unity3d.com/2019.4/Documentation/Manual/ScriptCompilationAssemblyDefinitionFiles.html#define-symbols>Version Defines</a>.
Because Avatar Optimizer didn&rsquo;t have public API prior to 1.6.0 and will break in 2.0.0,
it&rsquo;s recommended to add version range like <code>[1.6,2.0)</code>
(or stricter like <code>[1.7,2.0)</code> when you need new APIs that can be available in the future).</p><p><img src=version-defines.png alt=version-defines.png></p><p>Then, define <code>ComponentInformation</code> for your component in your assembly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>#if</span> AVATAR_OPTIMIZER &amp;&amp; UNITY_EDITOR
</span></span><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>[ComponentInformation(typeof(YourComponent))]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>YourComponentInformation</span> : ComponentInformation&lt;YourComponent&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> CollectMutations(YourComponent component, ComponentMutationsCollector collector)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// call methods on the collector to tell about the component</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> CollectDependency(YourComponent component, ComponentDependencyCollector collector)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// call methods on the collector to tell about the component</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#endif</span>
</span></span></code></pre></div><p>In <code>CollectMutations</code>, you should register any mutation your component may do.<br>In <code>CollectDependency</code>, you should register build-time or run-time dependencies and related information of your component.<br>Please read xmldoc of each methods for more details.</p><h3 id=asset-description>Use Asset Description
<a class=anchor href=#asset-description>#</a></h3><p>Please refer <a href=../asset-description>Asset Description</a> for more details.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://ndmf.nadena.dev/>NDMF</a>, Non-Destructive Modular Framework, is a framework for running non-destructive build plugins when
building avatars by bdunderscore. Avatar Optimizer uses that framework for compatibility
with many non-destructive tools based on NDMF.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>The file defines assembly other than Assembly-CSharp. Please refer <a href=https://docs.unity3d.com/2019.4/Documentation/Manual/ScriptCompilationAssemblyDefinitionFiles.html>unity docs</a>.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/anatawa12/AvatarOptimizer/edit/master/.docs/content/docs/developers/make-your-components-compatible-with-aao/index.md target=_blank rel=noopener><img src=/avatar-optimizer/beta/svg/edit.svg class=book-icon alt>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#when-incompatible>When can components be incompatible with Avatar Optimizer?</a></li><li><a href=#improve-compatibility>How to improve the compatibility?</a><ul><li><a href=#remove-component>Removing your components</a></li><li><a href=#register-component>Registering your components</a></li><li><a href=#asset-description>Use Asset Description</a></li></ul></li></ul></nav></div></aside></main></body></html>