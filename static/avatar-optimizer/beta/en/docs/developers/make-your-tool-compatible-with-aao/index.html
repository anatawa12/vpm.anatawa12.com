<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Make your tool compatible with Avatar Optimizer # This page describes the following two things.
When your tool can be incompatible with Avatar Optimizer? How to improve the compatibility? If you have some question, please feel free to ask @anatawa12@misskey.niri.la on fediverse.
When your tool can be incompatible with Avatar Optimizer? # If your tool doesn&rsquo;t add any components to the avatar and does nothing on the build time, your tool is already compatible with Avatar Optimizer!"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Make your tool compatible with Avatar Optimizer"><meta property="og:description" content="Make your tool compatible with Avatar Optimizer # This page describes the following two things.
When your tool can be incompatible with Avatar Optimizer? How to improve the compatibility? If you have some question, please feel free to ask @anatawa12@misskey.niri.la on fediverse.
When your tool can be incompatible with Avatar Optimizer? # If your tool doesn&rsquo;t add any components to the avatar and does nothing on the build time, your tool is already compatible with Avatar Optimizer!"><meta property="og:type" content="article"><meta property="og:url" content="https://vpm.anatawa12.com/avatar-optimizer/beta/en/docs/developers/make-your-tool-compatible-with-aao/"><meta property="article:section" content="docs"><title>Make your tool compatible with Avatar Optimizer | Avatar Optimizer (1.6.0-beta.12)</title><link rel=manifest href=/avatar-optimizer/beta/manifest.json><link rel=icon href=/avatar-optimizer/beta/favicon.png type=image/x-icon><link rel=alternate hreflang=en-us href=https://vpm.anatawa12.com/avatar-optimizer/beta/ja/docs/developers/make-your-tool-compatible-with-aao/ title="ツールをAvatar Optimizerとの互換性をもたせる"><link rel=stylesheet href=/avatar-optimizer/beta/book.min.64287bb2bc5e63dd96043b64dcc8e66fe7599fb14cdacd5ea8f32e26a37e3045.css integrity="sha256-ZCh7srxeY92WBDtk3Mjmb+dZn7FM2s1eqPMuJqN+MEU=" crossorigin=anonymous><script defer src=/avatar-optimizer/beta/flexsearch.min.js></script>
<script defer src=/avatar-optimizer/beta/en.search.min.f045faf29b2a3ae6ec4693573ea2d0fa2e520b662bed55db501e81babeb2f5a1.js integrity="sha256-8EX68psqOubsRpNXPqLQ+i5SC2Yr7VXbUB6Bur6y9aE=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/avatar-optimizer/beta/en/><span>Avatar Optimizer (1.6.0-beta.12)</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul class=book-languages><li><input type=checkbox id=languages class=toggle>
<label for=languages class="flex justify-between"><a role=button class="flex align-center"><img src=/avatar-optimizer/beta/svg/translate.svg class=book-icon alt=Languages>
English</a></label><ul><li><a href=https://vpm.anatawa12.com/avatar-optimizer/beta/ja/docs/developers/make-your-tool-compatible-with-aao/>日本語</a></li></ul></li></ul><a class=ao-stable-beta href=https://vpm.anatawa12.com/avatar-optimizer/en/docs/developers/make-your-tool-compatible-with-aao/>Goto Stable Docs</a><ul><li class=book-section-flat><span>Tutorial</span><ul><li><a href=/avatar-optimizer/beta/en/docs/tutorial/basic-usage/>Basic Usage</a></li></ul></li><li><a href=/avatar-optimizer/beta/en/docs/changelog/>Changelog</a></li><li class=book-section-flat><span>Component Kinds</span><ul><li><a href=/avatar-optimizer/beta/en/docs/component-kind/avatar-global-components/>Avatar Global Components</a></li><li><a href=/avatar-optimizer/beta/en/docs/component-kind/edit-skinned-mesh-components/>Edit Skinned Mesh Components</a></li></ul></li><li class=book-section-flat><span>Component Reference</span><ul><li><a href=/avatar-optimizer/beta/en/docs/reference/trace-and-optimize/>Trace And Optimize</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/unused-bones-by-references-tool/>UnusedBonesByReferencesTool</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/merge-skinned-mesh/>Merge Skinned Mesh</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/freeze-blendshape/>Freeze BlendShape</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/merge-toonlit-material/>Merge ToonLit Material</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/remove-mesh-by-blendshape/>Remove Mesh By BlendShape</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/remove-mesh-in-box/>Remove Mesh in Box</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/clear-endpoint-position/>Clear Endpoint Position</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/merge-bone/>Merge Bone</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/merge-physbone/>Merge PhysBone</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/remove-zero-sized-polygon/>Remove Zero Sized Polygon</a></li><li><a href=/avatar-optimizer/beta/en/docs/reference/make-children/>Make Children</a></li></ul></li><li class=book-section-flat><span>For Developers</span><ul><li><a href=/avatar-optimizer/beta/en/docs/developers/make-your-tool-compatible-with-aao/ class=active>Make your tool compatible with Avatar Optimizer</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/avatar-optimizer/beta/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Make your tool compatible with Avatar Optimizer</strong>
<label for=toc-control><img src=/avatar-optimizer/beta/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#when-incompatible>When your tool can be incompatible with Avatar Optimizer?</a></li><li><a href=#improve-compatibility>How to improve the compatibility?</a><ul><li><a href=#improve-compatibility-ndmf-based>For NDMF based non-destructive tools</a></li><li><a href=#improve-compatibility-non-ndmf-based>For non-NDMF based non-destructive tools</a></li><li><a href=#non-destructive-tools>For other tools that just holds data with components.</a></li><li><a href=#register-component>Registering your components</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=make-your-tool-compatible-with-avatar-optimizer>Make your tool compatible with Avatar Optimizer
<a class=anchor href=#make-your-tool-compatible-with-avatar-optimizer>#</a></h1><p>This page describes the following two things.</p><ul><li>When your tool can be incompatible with Avatar Optimizer?</li><li>How to improve the compatibility?</li></ul><p>If you have some question, please feel free to ask <a href=https://misskey.niri.la/@anatawa12><code>@anatawa12@misskey.niri.la</code> on fediverse</a>.</p><h2 id=when-incompatible>When your tool can be incompatible with Avatar Optimizer?
<a class=anchor href=#when-incompatible>#</a></h2><p>If your tool doesn&rsquo;t add any components to the avatar and does nothing on the build time,
your tool is already compatible with Avatar Optimizer!</p><p>If your tool adds some components to some portion of Avatar, your tool can be incompatible with Avatar Optimizer.</p><p>Since Avatar Optimizer has Garbage Collection system for Components and else, Avatar Optimizer have to
know about all existing components in your Avatar at the optimization.</p><p>To avoid problem with unknown components, the Avatar Optimizer currently assumes unknown components</p><ul><li>have some side-effects.</li><li>will have dependency relationship to all components referenced in the component.
(They can be changed in the future.)</li></ul><p>However, the assumption can be incorrect so Avatar Optimizer will generate the following warning.</p><p><img src=unknown-component-warning.png alt=unknown-component-warning></p><p>If your tool is non-NDMF<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>-based non-destructive tools that will also be applied on entering play mode,
Avatar Optimizer might be proceed before applying your plugin.</p><h2 id=improve-compatibility>How to improve the compatibility?
<a class=anchor href=#improve-compatibility>#</a></h2><h3 id=improve-compatibility-ndmf-based>For NDMF based non-destructive tools
<a class=anchor href=#improve-compatibility-ndmf-based>#</a></h3><p>If your tool is a non-destructive tools based on NDMF<sup id=fnref1:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, please remove your components before
Avatar Optimizer process. Avatar Optimizer does most thing in Optimization pass
so if your plugin do nothing in Optimization pass, nothing is problem.
If your tool needs your components in Optimization pass,
please execute before Avatar Optimizer with <a href=https://ndmf.nadena.dev/api/nadena.dev.ndmf.fluent.Sequence.html#nadena_dev_ndmf_fluent_Sequence_BeforePlugin_System_String_System_String_System_Int32_><code>BeforePlugin</code></a>.
QualifiedName of Avatar Optimizer in NDMF is <code>com.anatawa12.avatar-optimizer</code>.</p><p>If your tool actually want to do something with your components in Optimization pass,
please <a href=#register-component>register your component</a> to Avatar Optimizer.</p><h3 id=improve-compatibility-non-ndmf-based>For non-NDMF based non-destructive tools
<a class=anchor href=#improve-compatibility-non-ndmf-based>#</a></h3><p>If your tool is a non-destructive tools not based on NDMF<sup id=fnref2:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, please consider
make your tool based on NDMF.</p><p>If your tool is applied on play, to ensure compatibility with Avatar Optimizer, you have to use NDMF to
guarantee applying ordering between Avatar Optimizer and your tool.
If your tool does something only on building avatar, making your tool based on NDMF is not required.</p><p>If you don&rsquo;t want to make your took based on NDMF, please remove your component before processing Avatar Optimizer.
To achieve this, please execute your tool before NDMF&rsquo;s Optimization pass.
Currently NDMF executes Optimization passes in order <code>-1025</code>, JUST before VRCSDK&rsquo;s <code>RemoveAvatarEditorOnly</code> callback so
your tool should register <code>IVRCSDKPreprocessAvatarCallback</code> with smaller <code>callbackOrder</code>.</p><p>If your tool actually want to do something with your components after Avatar Optimizer (Optimization pass in NDMF),
please <a href=#register-component>register your component</a> to Avatar Optimizer.</p><h3 id=non-destructive-tools>For other tools that just holds data with components.
<a class=anchor href=#non-destructive-tools>#</a></h3><p>If your tool holds some information with components and doesn&rsquo;t have meaning at the build time,
please remove your component before Avatar Optimizer with <code>IVRCSDKPreprocessAvatarCallback</code> or
register your component to Avatar Optimizer.</p><p>When you want to remove your component with <code>IVRCSDKPreprocessAvatarCallback</code>, please refer <a href=#improve-compatibility-non-ndmf-based>this section</a>.</p><p>When you want to register your component to Avatar Optimizer, please refer <a href=#register-component>this section</a>.</p><h3 id=register-component>Registering your components
<a class=anchor href=#register-component>#</a></h3><p>If your tool want to keep your component after processing Avatar Optimizer, or want to removed by Avatar Optimizer,
you can register your component to Avatar Optimizer to tell about your component.</p><p>To call APIs in Avatar Optimizer, first, Please make assembly definition file<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> if your tool doesn&rsquo;t have.</p><p>Next, add <code>com.anatawa12.avatar-optimizer.api.editor</code> to assembly references in asmdef file.
If your tool doesn&rsquo;t want to depends on Avatar Optimizer, please use <a href=https://docs.unity3d.com/2019.4/Documentation/Manual/ScriptCompilationAssemblyDefinitionFiles.html#define-symbols>Version Defines</a>.
Because Avatar Optimizer didn&rsquo;t have public API piror to 1.6.0 and will break api in 2.0.0,
it&rsquo;s recommended to add version range like <code>[1.6,2.0)</code> (or more stricter like <code>[1.7,2.0)</code>).</p><p><img src=version-defines.png alt=version-defines.png></p><p>Then, define <code>CompoinentInformation</code> for your component in your assembly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>#if AVATAR_OPTIMIZER &amp;&amp; UNITY_EDITOR</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>[ComponentInformation(typeof(YourComponent))]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>YourComponentInformation</span> : ComponentInformation&lt;YourComponent&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> CollectMutations(YourComponent component, ComponentMutationsCollector collector)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// call methods on the collector to tell about the component</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> CollectDependency(YourComponent component, ComponentDependencyCollector collector)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// call methods on the collector to tell about the component</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>endif
</span></span></code></pre></div><p>In <code>CollectDependency</code>, you should register build-time or run-time dependencies of your component.
In <code>CollectMutations</code>, you should register any mutation your component may do.
Please refer xmldoc and method name for more datails.</p><p>If your component is just for keeping data for your in-editor tools, both will be empty method.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://ndmf.nadena.dev/>NDMF</a>, Non-Destructive Modular Framework, is a framework for running non-destructive build plugins when
building avatars by bdunderscore. Avatar Optimizer uses that framework for compatibility
with many non-destructive tools based on NDMF.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref2:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>The file defines assembly other than Assembly-CSharp. Please refer <a href=https://docs.unity3d.com/2019.4/Documentation/Manual/ScriptCompilationAssemblyDefinitionFiles.html>unity docs</a>.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/anatawa12/AvatarOptimizer/edit/master/.docs/content/docs/developers/make-your-tool-compatible-with-aao/index.md target=_blank rel=noopener><img src=/avatar-optimizer/beta/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#when-incompatible>When your tool can be incompatible with Avatar Optimizer?</a></li><li><a href=#improve-compatibility>How to improve the compatibility?</a><ul><li><a href=#improve-compatibility-ndmf-based>For NDMF based non-destructive tools</a></li><li><a href=#improve-compatibility-non-ndmf-based>For non-NDMF based non-destructive tools</a></li><li><a href=#non-destructive-tools>For other tools that just holds data with components.</a></li><li><a href=#register-component>Registering your components</a></li></ul></li></ul></nav></div></aside></main></body></html>